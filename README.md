# Вебхук МойСклад — выбор склада по остаткам

Сервис для МойСклад: при создании/изменении заказа проверяет остатки по складам в порядке приоритета **Москва → СПБ → Интернет-магазин** и выставляет склад, на котором **все** позиции заказа есть в наличии.

Решает проблему InSales, когда при приоритетном складе «Москва» заказы уходят с Москвы даже при нулевых остатках, а товар есть в СПБ или на складе «Интернет-магазин».

## Настройка

### Переменные окружения (Vercel / .env)

| Переменная | Описание |
|------------|----------|
| `MOYSKLAD_TOKEN` | Токен API МойСклад (если не задан — используется захардкоженный в коде). |
| `MOYSKLAD_WAREHOUSE_MSK` | ID склада Москва (entity/store). |
| `MOYSKLAD_WAREHOUSE_SPB` | ID склада СПБ. |
| `MOYSKLAD_WAREHOUSE_ONLINE` | ID склада «Интернет-магазин». **Обязательно задать**, если нужна проверка третьего склада. Если пусто — проверяются только МСК и СПБ. |
| `MOYSKLAD_API_DELAY_MS` | Задержка между запросами к API в миллисекундах (по умолчанию `300`). Увеличь, если МойСклад режет по лимитам. |

ID складов можно взять в МойСклад: **Настройки → Склады** или через API: `GET https://api.moysklad.ru/api/remap/1.2/entity/store`.

### Логика

1. Приходит вебхук от МойСклад по заказу.
2. Собираются позиции заказа (товары и варианты; услуги и комплекты не проверяются).
3. По очереди проверяются склады: **МСК → СПБ → Интернет-магазин**.
4. Выбирается **первый** склад, на котором по остаткам хватает **всех** позиций.
5. Если текущий склад заказа не совпадает с выбранным — заказ обновляется (меняется склад отгрузки).

Синхронизация МойСклад ↔ InSales (раз в 10 минут) подтянет обновлённый склад обратно в InSales.

## Деплой на Vercel

- Репозиторий подключается к Vercel, endpoint вебхука: `POST /api/webhook`.
- В настройках проекта добавь переменные окружения (см. таблицу выше).
- В МойСклад укажи URL вебхука: `https://<твой-проект>.vercel.app/api/webhook`.
